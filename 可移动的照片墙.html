<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>无标题文档</title>
<style>
*{margin:0;padding:0}
ul{list-style:none}
#box{ width:624px; height:312px; margin:20px auto; border:1px solid #000;}
#box ul{ width:624px; height:312px; position:relative;}
#box ul li{ width:100px; height:100px; position:absolute; font-size:24px;}
#box ul li.cur{ width:92px; height:92px; border:4px dotted #666;}
</style>
<script>
window.onload=function(){
	var oBox=document.getElementById("box"),
		oUl=oBox.children[0],
		aLi=document.getElementsByTagName("li"),
		oFrag=document.createDocumentFragment();
		
	for(var i=0;i<18;i++){
		var oLi=createLi(i+1);
		var row=Math.floor(i/6);
		var col=i%6;
		var left=col*100+4*col,top=row*100+4*(row+1);
		oLi.style.left=left+"px";
		oLi.style.top=top+"px";
		oFrag.appendChild(oLi);		
	}
	oUl.appendChild(oFrag);
		
	function createLi(text){
		var oLi=document.createElement("li");
		oLi.innerHTML=text;
		oLi.style.background="rgb("+getRandom(0,255)+","+getRandom(0,255)+","+getRandom(0,255)+")";
		
		//绑定移动事件
		oLi.onmousedown=function(ev){
			var oEvent=ev||event;
			var x=oEvent.clientX;
			var y=oEvent.clientY;
			var dx=x-oLi.offsetLeft;
			var dy=y-oLi.offsetTop;
			oLi.style.cursor="move";
			
			//生成一个虚线框li
			var dotLi=createDotLi(oLi.offsetLeft,oLi.offsetTop);
			oUl.appendChild(dotLi);
			
			document.onmousemove=function(ev){
				var oEvent=ev||event;
				oLi.style.left=oEvent.clientX-dx+"px";
				oLi.style.top=oEvent.clientY-dy+"px";
				//判断是否进到其他div
				var hitLi=isHit(oLi);
				if(!hitLi) return;
				//虚线框li和碰到的li交换位置
				exchangeLi(dotLi, hitLi);
			}
			document.onmouseup=function(){
				document.onmousemove=document.onmouseup=null;		
				oLi.style.cursor="default";
				//放开鼠标后，交换oLi和虚线框的位置
				move(oLi,{left:dotLi.offsetLeft, top:dotLi.offsetTop});
				//删除虚线框
				oUl.removeChild(dotLi);		
				dotLi=null;
				oLi.releaseCapture && oLi.releaseCapture();
			}
			
			oLi.setCapture && oLi.setCapture();
			return false;
			
		}
		
		return oLi;
	}
	
	//虚线框和li互换位置
	function exchangeLi(dotLi, oLi){
		var dotLeft=dotLi.offsetLeft,
			dotTop=dotLi.offsetTop;
		dotLi.style.left=oLi.offsetLeft+"px";
		dotLi.style.top=oLi.offsetTop+"px";
		oLi.style.left=dotLeft+"px";
		oLi.style.top=dotTop+"px";
	}
	
	//创建虚线框
	function createDotLi(left,top){
		var dotLi=document.createElement("li");
		dotLi.className="cur";
		dotLi.style.left=left+"px";
		dotLi.style.top=top+"px";
		return dotLi;
	}
	
	//碰撞检测
	function isHit(oLi){
		for(var i=0,len=aLi.length;i<len;i++){
			if(aLi[i].className=="cur" || aLi[i]===oLi) continue;
			var xCenter=oLi.offsetLeft+oLi.offsetWidth/2;
			var yCenter=oLi.offsetTop+oLi.offsetHeight/2;
			//在aLi[i]外面未碰到，反之就是碰上了
			if(!( xCenter<aLi[i].offsetLeft || yCenter<aLi[i].offsetTop || xCenter>aLi[i].offsetLeft+aLi[i].offsetWidth || yCenter>aLi[i].offsetTop+aLi[i].offsetHeight)){
				return aLi[i];
			}
		}
		return false;
	}
	
	//匀速运动
	function move(obj,oAttr){
		clearInterval(obj.timer);
		
		obj.timer=setInterval(function(){
			var speed=6;	
			var isOver=true;
			for(var attr in oAttr){		
				var target=oAttr[attr];
				var nowVal=parseInt(getStyle(obj,attr));
				target>nowVal?speed=6:speed=-6;  		
				if(Math.abs(target-nowVal)<=Math.abs(speed)){
					obj.style[attr]=target+"px";
					continue;
				}
				else{
					isOver=false;
					obj.style[attr]=nowVal+speed+"px";
				}
			}
			isOver && clearInterval(obj.timer);			
		},30);
	}
	
	function getStyle(obj,attr){
		return obj.currentStyle?obj.currentStyle[attr]:getComputedStyle(obj,false)[attr];
	}
	
	function getRandom(m,n){
		return parseInt(Math.random()*(n-m+1)+m);
	}
}
</script>
</head>

<body>
<div id="box">
	<ul></ul>
</div>
</body>
</html>
